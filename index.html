<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>ESP32 MQTT Control (HiveMQ)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:20px;background:#f7f9fc;color:#222}
    .card{background:#fff;padding:12px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.06);margin-bottom:12px}
    button{padding:8px 12px;margin:6px;border-radius:6px;border:1px solid #ccc;background:#f0f0f0;cursor:pointer}
    .on{background:#2ecc71;color:#fff;border-color:#27ae60}
    .off{background:#e74c3c;color:#fff;border-color:#c0392b}
    .tele {font-family:monospace;background:#fafafa;padding:8px;border-radius:6px}
  </style>
</head>
<body>
  <h2>ESP32 — MQTT Control (HiveMQ)</h2>

  <div class="card">
    <strong>Connection</strong><br>
    Broker: <code>broker.hivemq.com</code> (WebSocket ws://broker.hivemq.com:8884/mqtt)<br>
    Client ID: <span id="cid">...</span><br>
    Status: <span id="status">disconnected</span>
  </div>

  <div class="card">
    <strong>Controls (mirip Blynk)</strong><br>
    <button id="pb1_on">PB1 ON</button>
    <button id="pb1_off">PB1 OFF</button>
    <button id="pb2">PB2 (cycle)</button>
    <button id="pb3">PB3 (cycle)</button>
    <button id="pln_on" class="on">PLN ON</button>
    <button id="pln_off" class="off">PLN OFF</button>
  </div>

  <div class="card">
    <strong>Telemetry (updates)</strong>
    <div class="tele" id="tele">menunggu data...</div>
  </div>

<script>
  // koneksi MQTT via WebSocket
  const brokerUrl = 'ws://broker.hivemq.com:8000/mqtt';
  const cid = 'web-' + Math.random().toString(16).substr(2,8);
  document.getElementById('cid').textContent = cid;

  const client = mqtt.connect(brokerUrl, { clientId: cid });

  const statusEl = document.getElementById('status');
  const teleEl = document.getElementById('tele');

  client.on('connect', function () {
    statusEl.textContent = 'connected';
    // subscribe telemetry wildcard
    client.subscribe('esp32/tele/#');
    // optional subscribe ack
    client.subscribe('esp32/ack/#');
  });
  client.on('reconnect', () => statusEl.textContent = 'reconnecting...');
  client.on('close', () => statusEl.textContent = 'disconnected');
  client.on('error', (e) => { statusEl.textContent = 'error'; console.error(e); });

  client.on('message', function (topic, payload) {
    const msg = payload.toString();
    // tampilkan di panel tele
    const time = new Date().toLocaleTimeString();
    teleEl.innerHTML = `<div>[${time}] ${topic} → ${msg}</div>` + teleEl.innerHTML;
  });

  // Actions: publish to esp32/cmd/...
  function publishCmd(sub, payload) {
    client.publish('esp32/cmd/' + sub, payload.toString());
  }

  document.getElementById('pb1_on').addEventListener('click', () => {
    publishCmd('V5','1'); // mirror BLYNK V5 ON -> PB1_ON
  });
  document.getElementById('pb1_off').addEventListener('click', () => {
    publishCmd('V5','0'); // PB1_OFF
  });
  document.getElementById('pb2').addEventListener('click', () => {
    publishCmd('V7','1'); // trigger PB2_ON (device cycles internal)
  });
  document.getElementById('pb3').addEventListener('click', () => {
    publishCmd('V6','1'); // trigger PB3_ON
  });
  document.getElementById('pln_on').addEventListener('click', () => {
    publishCmd('PLN','ON');
  });
  document.getElementById('pln_off').addEventListener('click', () => {
    publishCmd('PLN','OFF');
  });

</script>
</body>
</html>


