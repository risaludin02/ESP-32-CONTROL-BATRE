<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ESP32 MQTT Dashboard</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body {
      font-family: Arial, Helvetica, sans-serif;
      background: #f5f7fb;
      color: #222;
      margin: 20px;
    }
    h2 { text-align: center; margin-bottom: 20px; }
    .card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      padding: 15px;
      margin-bottom: 15px;
    }
    button {
      padding: 8px 14px;
      margin: 5px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      transition: 0.2s;
    }
    button:hover { opacity: 0.85; }
    .on { background: #2ecc71; color: #fff; }
    .off { background: #e74c3c; color: #fff; }
    .neutral { background: #3498db; color: #fff; }
    .tele {
      font-family: monospace;
      background: #fafafa;
      border-radius: 8px;
      padding: 10px;
      max-height: 250px;
      overflow-y: auto;
    }
    #status { font-weight: bold; }
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      text-align: center;
    }
    .statusBox {
      background: #eef3f8;
      border-radius: 8px;
      padding: 10px;
      font-weight: bold;
    }
    .battery-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(100px,1fr));
      gap: 10px;
      text-align: center;
      margin-top: 10px;
    }
    .batteryBox {
      background: #eef3f8;
      border-radius: 8px;
      padding: 8px;
      font-weight: bold;
    }
  </style>
</head>

<body>
  <h2>ESP32 MQTT Dashboard (HiveMQ Secure 8884)</h2>

  <div class="card">
    <strong>Koneksi</strong><br>
    Broker: <code>wss://broker.hivemq.com:8884/mqtt</code><br>
    Client ID: <span id="cid">...</span><br>
    Status: <span id="status">disconnected</span>
  </div>

  <div class="card">
    <strong>Kontrol (sesuai Blynk)</strong><br>
    <button id="pb1_on" class="on">PB1 ON</button>
    <button id="pb1_off" class="off">PB1 OFF</button>
    <button id="pb2" class="neutral">PB2</button>
    <button id="pb3" class="neutral">PB3</button>
  </div>

  <div class="card">
    <strong>Status Sistem</strong>
    <div class="grid">
      <div class="statusBox" id="plnStatus">PLN: --</div>
      <div class="statusBox" id="dcStatus">DISCHARGE: --</div>
      <div class="statusBox" id="chStatus">CHARGER: --</div>
      <div class="statusBox" id="veVolt">VE: -- V</div>
    </div>
  </div>

  <div class="card">
    <strong>Level Tiap Baterai (Volt)</strong>
    <div class="battery-grid">
      <div class="batteryBox" id="voltA">VA: -- V</div>
      <div class="batteryBox" id="voltB">VB: -- V</div>
      <div class="batteryBox" id="voltC">VC: -- V</div>
      <div class="batteryBox" id="voltD">VD: -- V</div>
      <div class="batteryBox" id="voltE">VE: -- V</div>
    </div>
  </div>

  <div class="card">
    <strong>Data Telemetri</strong>
    <div class="tele" id="tele">Menunggu data...</div>
  </div>

<script>
  // ====== MQTT HiveMQ Secure ======
  const brokerUrl = "wss://broker.hivemq.com:8884/mqtt";
  const cid = "web-" + Math.random().toString(16).substr(2, 8);
  document.getElementById("cid").textContent = cid;

  const client = mqtt.connect(brokerUrl, { clientId: cid });

  const statusEl = document.getElementById("status");
  const teleEl = document.getElementById("tele");

  const plnEl = document.getElementById("plnStatus");
  const dcEl  = document.getElementById("dcStatus");
  const chEl  = document.getElementById("chStatus");
  const veEl  = document.getElementById("veVolt");

  const vAEl = document.getElementById("voltA");
  const vBEl = document.getElementById("voltB");
  const vCEl = document.getElementById("voltC");
  const vDEl = document.getElementById("voltD");
  const vEEl = document.getElementById("voltE");

  client.on("connect", () => {
    statusEl.textContent = "connected";
    statusEl.style.color = "green";
    client.subscribe("esp32/tele/#");
    client.subscribe("esp32/ack/#");
  });

  client.on("reconnect", () => {
    statusEl.textContent = "reconnecting...";
    statusEl.style.color = "orange";
  });
  client.on("close", () => {
    statusEl.textContent = "disconnected";
    statusEl.style.color = "red";
  });
  client.on("error", (err) => {
    console.error("MQTT Error:", err);
    statusEl.textContent = "error";
    statusEl.style.color = "red";
  });

  // ====== Menerima pesan ======
  client.on("message", (topic, payload) => {
    const msg = payload.toString();
    const time = new Date().toLocaleTimeString();
    teleEl.innerHTML = `<div>[${time}] ${topic} → ${msg}</div>` + teleEl.innerHTML;

    // PLN
    if (topic === "esp32/tele/PLN") {
      if (msg === "1" || msg.toUpperCase() === "ON") {
        plnEl.textContent = "PLN: ON";
        plnEl.style.color = "green";
      } else {
        plnEl.textContent = "PLN: OFF";
        plnEl.style.color = "red";
      }
    }

    // DC & CH
    if (topic === "esp32/tele/DC") {
      dcEl.textContent = "DISCHARGE: " + msg;
      dcEl.style.color = msg != "0" ? "green" : "#555";
    }
    if (topic === "esp32/tele/CH") {
      chEl.textContent = "CHARGER: " + msg;
      chEl.style.color = msg != "0" ? "blue" : "#555";
    }

    // Voltase baterai A–E
    if (topic === "esp32/tele/V0") updateVolt(vAEl, "VA", msg);
    if (topic === "esp32/tele/V1") updateVolt(vBEl, "VB", msg);
    if (topic === "esp32/tele/V2") updateVolt(vCEl, "VC", msg);
    if (topic === "esp32/tele/V3") updateVolt(vDEl, "VD", msg);
    if (topic === "esp32/tele/V4") {
      updateVolt(vEEl, "VE", msg);
      veEl.textContent = "VE: " + parseFloat(msg).toFixed(2) + " V";
      veEl.style.color = "#333";
    }
  });

  // ====== Fungsi pewarnaan voltase ======
  function updateVolt(el, label, val) {
    const v = parseFloat(val);
    el.textContent = `${label}: ${v.toFixed(2)} V`;
    if (v >= 12.5) el.style.color = "green";
    else if (v >= 11.8) el.style.color = "orange";
    else el.style.color = "red";
  }

  // ====== Fungsi publish kontrol ======
  function publishCmd(sub, payload) {
    client.publish("esp32/cmd/" + sub, payload.toString());
  }

  // ====== Tombol kontrol ======
  document.getElementById("pb1_on").addEventListener("click", () => publishCmd("V5", "1"));
  document.getElementById("pb1_off").addEventListener("click", () => publishCmd("V5", "0"));
  document.getElementById("pb2").addEventListener("click", () => publishCmd("V7", "1"));
  document.getElementById("pb3").addEventListener("click", () => publishCmd("V6", "1"));
</script>
</body>
</html>
